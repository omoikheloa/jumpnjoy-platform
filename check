#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# -----------------------------
# User-editable variables
# -----------------------------
APP_ROOT="/opt/jumpnjoy"
BACKEND_DIR="$APP_ROOT/backend"        # put your Django project here (manage.py etc)
FRONTEND_DIR="$APP_ROOT/frontend"      # put your frontend source here (package.json + package-lock.json)
VENV_DIR="$BACKEND_DIR/venv"
DJANGO_SETTINGS_MODULE="config.settings"  # change if your django settings module differs
GUNICORN_MODULE="config.wsgi:application" # Django WSGI path; adjust if different
GUNICORN_PORT=8000
DB_NAME="jumpnjoy_db"
DB_USER="jumpnjoy_user"
DB_PASS="CHANGE_THIS_DB_PASSWORD"        # <<< change to a very strong password
STATIC_ROOT="$BACKEND_DIR/staticfiles"  # where Django collectstatic will place files
FRONTEND_BUILD_DIR="$FRONTEND_DIR/dist" # typical for Vite; adjust if your build dir is different
NGINX_SITE_NAME="jumpnjoy"
LAN_SUBNET="192.168.1.0/24"              # change to your local subnet if different
ADMIN_USER="$(whoami)"                   # system user that will own files

# -----------------------------
# 1) Initial package install
# -----------------------------
echo "Updating system and installing apt packages..."
sudo apt update
sudo apt upgrade -y

sudo apt install -y python3 python3-venv python3-pip build-essential libpq-dev \
                    postgresql postgresql-contrib nginx ufw nodejs npm

# Optional: ensure npm is modern — if your Ubuntu's npm/node are very old, consider installing from NodeSource.

# -----------------------------
# 2) Create app directories and permissions
# -----------------------------
echo "Creating app directories..."
sudo mkdir -p "$BACKEND_DIR" "$FRONTEND_DIR" "$STATIC_ROOT"
sudo chown -R "$ADMIN_USER":"$ADMIN_USER" "$APP_ROOT"
sudo chmod -R u+rwx "$APP_ROOT"

# -----------------------------
# 3) PostgreSQL: create DB & user
# -----------------------------
echo "Configuring PostgreSQL..."
sudo -u postgres psql -c "SELECT 1;" >/dev/null

# create user, database and grant privileges (idempotent-ish)
sudo -u postgres psql <<SQL
DO
\$do\$
BEGIN
   IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${DB_USER}') THEN
      CREATE ROLE ${DB_USER} LOGIN PASSWORD '${DB_PASS}';
   END IF;
END
\$do\$;

CREATE DATABASE ${DB_NAME} OWNER ${DB_USER};
GRANT ALL PRIVILEGES ON DATABASE ${DB_NAME} TO ${DB_USER};
SQL

# NOTE: if DB already exists, CREATE DATABASE will fail; that's okay — edit as required.

# -----------------------------
# 4) Python virtualenv & pip install
# -----------------------------
echo "Creating Python virtualenv and installing backend requirements..."
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"

# install pip tools first
pip install --upgrade pip setuptools wheel

# Use your uploaded requirements.txt (make sure it exists)
if [ ! -f "$BACKEND_DIR/requirements.txt" ]; then
  echo "ERROR: $BACKEND_DIR/requirements.txt not found. Place your requirements.txt there (uploaded file)."
  exit 1
fi

pip install -r "$BACKEND_DIR/requirements.txt"

#  - requirements.txt includes Django, djangorestframework, gunicorn, whitenoise, psycopg2-binary. See uploaded file. :contentReference[oaicite:4]{index=4}

deactivate

# -----------------------------
# 5) Frontend: install node deps (exact versions) and build
# -----------------------------
echo "Installing frontend dependencies (exact versions using package-lock.json) and building..."
if [ ! -f "$FRONTEND_DIR/package-lock.json" ]; then
  echo "ERROR: $FRONTEND_DIR/package-lock.json not found. Place your uploaded package-lock.json there. Aborting."
  exit 1
fi

cd "$FRONTEND_DIR"
# install exact versions using package-lock.json
npm ci

# build (assumes script "build" in package.json, common with Vite)
if npm run | grep -q " build"; then
  npm run build
else
  echo "WARNING: no 'build' script found in package.json. Skipping frontend build step."
fi

# -----------------------------
# 6) Django static files & migrations
# -----------------------------
echo "Collecting static files and applying migrations..."
source "$VENV_DIR/bin/activate"
cd "$BACKEND_DIR"

# Set env variables for Django so manage.py can run without secrets in code (temporary for script)
export DJANGO_SETTINGS_MODULE="$DJANGO_SETTINGS_MODULE"
export DATABASE_URL="postgres://$DB_USER:$DB_PASS@localhost:5432/$DB_NAME"

# If your project uses dj-database-url, it will read DATABASE_URL; otherwise edit your settings.py accordingly.

# Migrate
python manage.py migrate --noinput || true

# Create superuser if not exists (change email/username as needed)
python - <<PY
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', '${DJANGO_SETTINGS_MODULE}')
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(username='admin').exists():
    User.objects.create_superuser('admin','admin@example.com','adminpass123')
    print('Created admin superuser (username=admin, password=adminpass123). Please change this password ASAP.')
else:
    print('Superuser admin already exists.')
PY

# Collect static into STATIC_ROOT
python manage.py collectstatic --noinput

# Optionally copy frontend build into Django static (if you want to serve SPA from same origin)
if [ -d "$FRONTEND_BUILD_DIR" ]; then
  echo "Copying frontend build into Django static files..."
  cp -r "$FRONTEND_BUILD_DIR"/* "$STATIC_ROOT"/
fi

deactivate

# -----------------------------
# 7) Gunicorn systemd service for backend
# -----------------------------
echo "Configuring Gunicorn systemd service..."
SERVICE_FILE="/etc/systemd/system/jumpnjoy-gunicorn.service"

sudo bash -c "cat > $SERVICE_FILE" <<'SYSTEMD'
[Unit]
Description=gunicorn daemon for JumpnJoy Django app
After=network.target

[Service]
User=__USER__
Group=www-data
WorkingDirectory=__BACKEND_DIR__
Environment=PATH=__VENV__/bin
Environment=DATABASE_URL=__DATABASE_URL__
ExecStart=__VENV__/bin/gunicorn --workers 3 --bind 127.0.0.1:__PORT__ __GUNICORN_MODULE__

[Install]
WantedBy=multi-user.target
SYSTEMD

# Replace tokens
sudo sed -i "s|__USER__|$ADMIN_USER|g" $SERVICE_FILE
sudo sed -i "s|__BACKEND_DIR__|$BACKEND_DIR|g" $SERVICE_FILE
sudo sed -i "s|__VENV__|$VENV_DIR|g" $SERVICE_FILE
sudo sed -i "s|__DATABASE_URL__|$DATABASE_URL|g" $SERVICE_FILE
sudo sed -i "s|__PORT__|$GUNICORN_PORT|g" $SERVICE_FILE
sudo sed -i "s|__GUNICORN_MODULE__|$GUNICORN_MODULE|g" $SERVICE_FILE

sudo systemctl daemon-reload
sudo systemctl enable --now jumpnjoy-gunicorn.service

# -----------------------------
# 8) Configure Nginx to serve frontend assets and proxy /api to backend
# -----------------------------
echo "Configuring Nginx..."
NGINX_CONF="/etc/nginx/sites-available/$NGINX_SITE_NAME"

sudo bash -c "cat > $NGINX_CONF" <<NGINX
server {
    listen 80;
    server_name _;

    # Serve frontend static files (Vite build) directly, if present
    root $__FRONTEND_BUILD__ ;

    # Example: serve index.html for SPA routes
    location / {
        try_files \$uri /index.html;
    }

    # Serve Django static files (collected to STATIC_ROOT) under /static/
    location /static/ {
        alias $__STATIC_ROOT__;
    }

    # Proxy API requests (adjust path if your API root differs)
    location /api/ {
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_pass http://127.0.0.1:__PORT__ ;
    }

    # Optional: admin or media endpoints can be proxied or served
}
NGINX

# Replace placeholders
sudo sed -i "s|__FRONTEND_BUILD__|$FRONTEND_BUILD_DIR|g" $NGINX_CONF
sudo sed -i "s|__STATIC_ROOT__|$STATIC_ROOT|g" $NGINX_CONF
sudo sed -i "s|__PORT__|$GUNICORN_PORT|g" $NGINX_CONF

sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/$NGINX_SITE_NAME
sudo nginx -t
sudo systemctl restart nginx

# -----------------------------
# 9) UFW: firewall rules for LAN-only access
# -----------------------------
echo "Configuring UFW firewall (allow http from LAN and allow SSH from LAN only)..."
sudo ufw default deny incoming
sudo ufw default allow outgoing

# allow HTTP from LAN only
sudo ufw allow from $LAN_SUBNET to any port 80 proto tcp

# Allow SSH from LAN for admin remote access (optional)
sudo ufw allow from $LAN_SUBNET to any port 22 proto tcp

sudo ufw --force enable
sudo ufw status numbered

# -----------------------------
# 10) Post-deploy reminders and tips
# -----------------------------
echo "Deployment script finished."
echo "Visit http://<your-machine-LAN-IP>/ from another LAN device to see the frontend (if build exists)."
echo "API endpoints proxied at /api/ will be forwarded to Django Gunicorn (127.0.0.1:$GUNICORN_PORT)."

echo "IMPORTANT NEXT STEPS:"
echo " - Replace DB password ($DB_PASS) with a strong one (or set via secrets manager / env file)."
echo " - Change the created Django admin password if you accepted the one above."
echo " - If you want HTTPS on LAN, create a self-signed certificate or install an internal CA and configure nginx for TLS."
