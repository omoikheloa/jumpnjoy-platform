#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

###############################################
# JumpnJoy LAN Deployment Script for Mint 22.2
###############################################

# -----------------------------
# CONFIGURATION VARIABLES
# -----------------------------
APP_ROOT="/opt/jumpnjoy"
BACKEND_DIR="$APP_ROOT/backend/backend"
FRONTEND_DIR="$APP_ROOT/frontend/frontend"
VENV_DIR="$BACKEND_DIR/venv"
GUNICORN_PORT=8000
GUNICORN_MODULE="jumpnjoy.wsgi:application"

DB_NAME="jumpnjoy_db"
DB_USER="jumpnjoy_user"
DB_PASS="Jumpnjoy2025"

LAN_IP="192.168.1.20"
LAN_SUBNET="192.168.1.0/24"          # ADAPT IF YOUR ROUTER USES DIFFERENT RANGE

ADMIN_USER="$(whoami)"

###############################################
# 1. Update and Install Packages
###############################################
echo "üì¶ Updating system..."
sudo apt update && sudo apt upgrade -y

echo "üì¶ Installing core services..."
sudo apt install -y python3 python3-venv python3-pip build-essential libpq-dev \
postgresql postgresql-contrib nginx ufw curl

###############################################
# 2. Ensure Node.js ‚â• 18 (Mint may ship older)
###############################################
echo "üîç Checking Node.js version..."
NODE_VERSION=$(node -v 2>/dev/null || echo "none")

if [[ "$NODE_VERSION" == "none" ]]; then
  echo "‚ùó Node.js not found ‚Äî installing Node.js 20"
  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
  sudo apt install -y nodejs
else
  echo "‚Ñπ Node.js present: $NODE_VERSION"
  if [[ "$NODE_VERSION" < "v18" ]]; then
    echo "‚ö† Node.js is outdated ‚Äî upgrading to Node.js 20"
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt install -y nodejs
  fi
fi

###############################################
# 3. Ensure directory structure exists
###############################################
echo "üìÅ Creating directories..."
sudo mkdir -p "$BACKEND_DIR" "$FRONTEND_DIR"
sudo chown -R "$ADMIN_USER":"$ADMIN_USER" "$APP_ROOT"

###############################################
# 4. PostgreSQL Setup
###############################################
echo "üêò Configuring PostgreSQL..."
sudo -u postgres psql <<SQL
DO \$\$
BEGIN
   IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${DB_USER}') THEN
      CREATE USER ${DB_USER} WITH PASSWORD '${DB_PASS}';
   END IF;
END
\$\$;

CREATE DATABASE ${DB_NAME} OWNER ${DB_USER};
GRANT ALL PRIVILEGES ON DATABASE ${DB_NAME} TO ${DB_USER};
SQL

###############################################
# 5. Python Virtual Environment & Dependencies
###############################################
echo "üêç Setting up Python virtualenv..."
cd "$BACKEND_DIR"
python3 -m venv venv
source "$VENV_DIR/bin/activate"
pip install --upgrade pip wheel setuptools

if [[ ! -f "$BACKEND_DIR/requirements.txt" ]]; then
  echo "‚ùå ERROR: requirements.txt missing in backend directory"
  exit 1
fi

pip install -r "$BACKEND_DIR/requirements.txt"
deactivate

###############################################
# 6. Frontend Install & Build (React)
###############################################
echo "üåê Building frontend..."
cd "$FRONTEND_DIR"

if [[ ! -f "package-lock.json" ]]; then
  echo "‚ùå ERROR: package-lock.json missing. Required for npm ci."
  exit 1
fi

npm ci
npm run build

###############################################
# 7. Configure Django for Production
###############################################
echo "‚öô Applying Django migrations & static collection..."
cd "$BACKEND_DIR"
source "$VENV_DIR/bin/activate"

if [[ ! -f ".env" ]]; then
  echo "‚ùå ERROR: .env missing in backend folder"
  exit 1
fi

export $(grep -v '^#' .env | xargs)

python manage.py migrate --noinput
python manage.py collectstatic --noinput
deactivate

###############################################
# 8. Create Gunicorn Service
###############################################
echo "üîß Creating Gunicorn systemd service..."
SERVICE=/etc/systemd/system/jumpnjoy-gunicorn.service

sudo bash -c "cat > $SERVICE" <<EOF
[Unit]
Description=Gunicorn for JumpnJoy Django App
After=network.target

[Service]
User=$ADMIN_USER
Group=www-data
WorkingDirectory=$BACKEND_DIR
EnvironmentFile=$BACKEND_DIR/.env
Environment=PATH=$VENV_DIR/bin
ExecStart=$VENV_DIR/bin/gunicorn --workers 3 --bind 127.0.0.1:$GUNICORN_PORT $GUNICORN_MODULE

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now jumpnjoy-gunicorn

###############################################
# 9. Configure NGINX Reverse Proxy
###############################################
echo "üåê Setting up Nginx..."
NGINX_CONF=/etc/nginx/sites-available/jumpnjoy

sudo bash -c "cat > $NGINX_CONF" <<EOF
server {
    listen 80;
    server_name $LAN_IP;

    location / {
        root $FRONTEND_DIR/dist;
        try_files \$uri /index.html;
    }

    location /static/ {
        alias $BACKEND_DIR/staticfiles/;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:$GUNICORN_PORT/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

###############################################
# 10. UFW Firewall for LAN Only
###############################################
echo "üõ° Configuring firewall..."
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow from $LAN_SUBNET to any port 80 proto tcp
sudo ufw allow from $LAN_SUBNET to any port 22 proto tcp
sudo ufw --force enable

echo "üéâ Deployment complete!"
echo "Open http://$LAN_IP/ from another device on your LAN"
